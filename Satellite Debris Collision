import pygame
import random
import math

pygame.init()
pygame.event.set_allowed([pygame.QUIT, pygame.KEYDOWN, pygame.MOUSEBUTTONDOWN])

WIDTH, HEIGHT = 1000, 800
screen = pygame.display.set_mode((WIDTH, HEIGHT))
pygame.display.set_caption("Kessler Syndrome Simulator")

clock = pygame.time.Clock()

CENTER = (WIDTH//2, HEIGHT//2)
EARTH_RADIUS = 70

satellites = []
debris = []

G = 0.12


class Satellite:

    def __init__(self, radius):

        self.orbit_radius = radius
        self.angle = random.uniform(0, math.pi*2)

        self.speed = math.sqrt(G * 5000 / radius)

        self.size = 4

    def update(self):

        self.angle += self.speed * 0.01

        self.x = CENTER[0] + math.cos(self.angle) * self.orbit_radius
        self.y = CENTER[1] + math.sin(self.angle) * self.orbit_radius

    def draw(self):
        pygame.draw.circle(screen, (200,220,255), (int(self.x), int(self.y)), self.size)


class Debris:

    def __init__(self, x, y):

        self.x = x
        self.y = y

        angle = random.uniform(0, math.pi*2)
        speed = random.uniform(1,3)

        self.vx = math.cos(angle)*speed
        self.vy = math.sin(angle)*speed

        self.life = random.randint(300,700)

    def update(self):

        dx = CENTER[0] - self.x
        dy = CENTER[1] - self.y
        r = math.sqrt(dx*dx + dy*dy)

        gravity = G * 4000 / r**2

        self.vx += gravity * dx / r
        self.vy += gravity * dy / r

        self.x += self.vx
        self.y += self.vy

        self.life -= 1

    def draw(self):
        pygame.draw.circle(screen, (255,120,120), (int(self.x), int(self.y)), 2)


running = True

while running:

    clock.tick(30)
    screen.fill((5,5,20))

    pygame.draw.circle(screen, (80,140,255), CENTER, EARTH_RADIUS)

    for event in pygame.event.get():

        if event.type == pygame.QUIT:
            running = False

        # click to add satellites
        if event.type == pygame.MOUSEBUTTONDOWN:
            r = random.randint(130, 260)
            satellites.append(Satellite(r))

        # trigger explosion
        if event.type == pygame.KEYDOWN and event.key == pygame.K_SPACE:

            if satellites:
                victim = random.choice(satellites)

                for _ in range(25):
                    debris.append(Debris(victim.x, victim.y))

                satellites.remove(victim)

    # update satellites
    for sat in satellites:
        sat.update()
        sat.draw()

    # debris logic
    for d in debris[:]:
        d.update()
        d.draw()

        if d.life <= 0:
            debris.remove(d)

        # collision with satellites
        for sat in satellites[:]:

            dist = math.hypot(d.x - sat.x, d.y - sat.y)

            if dist < 6:

                satellites.remove(sat)

                for _ in range(15):
                    debris.append(Debris(sat.x, sat.y))

    pygame.display.flip()

pygame.quit()
